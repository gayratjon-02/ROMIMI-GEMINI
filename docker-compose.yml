services:
  romimi-backend:
    container_name: romimi-backend
    build: .
    restart: always
    env_file:
      - .env.production
    ports:
      - "4001:5001"               # SERVER:CONTAINER - Backend runs on 5001 inside, exposed on 4001
    environment:
      NODE_ENV: production
      PORT_API: 5001

      DATABASE_URL: ${DATABASE_URL}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0

      # AI Keys
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-3-pro-image-preview}

      # Auth
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: 7d
      SECRET_TOKEN: ${JWT_SECRET}

      # CORS - Frontend runs on port 4000
      FRONTEND_URL: ${FRONTEND_URL:-http://167.172.90.235:4000}

      # File Uploads - Backend runs on port 4001
      FILE_STORAGE_PROVIDER: local
      UPLOAD_LOCAL_PATH: uploads
      UPLOAD_BASE_URL: ${UPLOAD_BASE_URL:-http://167.172.90.235:4001}
      UPLOAD_MAX_FILE_SIZE: 5242880
      UPLOAD_ALLOWED_MIME_TYPES: image/jpeg,image/png,image/webp

    volumes:
      - ./uploads:/usr/src/app/uploads

    depends_on:
      - redis
    networks:
      - backend-network

  redis:
    container_name: romimi-redis-v2
    image: redis:7-alpine
    restart: always
    command: >
      sh -c "redis-server --appendonly yes
      ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}"
    volumes:
      - redis_data:/data
    networks:
      - backend-network

volumes:
  redis_data:

networks:
  backend-network:
    driver: bridge
